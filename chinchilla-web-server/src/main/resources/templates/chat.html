<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${categoryTitle} + ' - 복지로 챗봇'">복지로 챗봇</title>
    <link rel="stylesheet" th:href="@{/css/chat.css}">
</head>
<body>
<div class="chat-header">
    <a href="/" class="back-button">←</a>
    <div class="header-title">
        <h2 th:text="${categoryTitle}">채팅</h2>
    </div>
    <div style="width: 40px;"></div>
</div>

<div class="chat-container">
    <!-- 일자리 매칭 프로필 섹션 -->
    <div class="profile-section" th:if="${category == 'jobs'}">
        <h3>프로필 입력</h3>
        <form id="profileForm">
            <div class="form-group">
                <label for="age">나이</label>
                <input type="number" id="age" min="60" max="100" value="65" required>
            </div>

            <div class="form-group">
                <label for="gender">성별</label>
                <select id="gender" required>
                    <option value="male">남성</option>
                    <option value="female">여성</option>
                </select>
            </div>

            <div class="form-group">
                <label for="location">거주 지역</label>
                <input type="text" id="location" placeholder="예: 서울시 강남구" required>
            </div>

            <div class="info-box">
                💡 프로필 정보는 맞춤형 일자리 추천을 위해 사용됩니다.
            </div>
        </form>
    </div>

    <!-- 법률 프로필 섹션 -->
    <div class="profile-section" th:if="${category == 'legal'}">
        <h3>프로필 입력</h3>
        <form id="profileForm">
            <div class="form-group">
                <label for="age">나이</label>
                <input type="number" id="age" min="1" max="120" value="65" required>
            </div>

            <div class="form-group">
                <label for="region">지역</label>
                <input type="text" id="region" placeholder="예: 서울시 강남구" required>
            </div>

            <div class="form-group">
                <label for="interest">관심 분야</label>
                <select id="interest" required>
                    <option value="상속/증여">상속/증여</option>
                    <option value="부동산">부동산</option>
                    <option value="금융">금융</option>
                    <option value="소비자보호">소비자보호</option>
                    <option value="복지">복지</option>
                    <option value="기타">기타</option>
                </select>
            </div>

            <div class="form-group">
                <label for="income">월 소득 (만원)</label>
                <input type="number" id="income" min="0" placeholder="예: 150" required>
            </div>

            <div class="info-box">
                💡 프로필 정보는 맞춤형 법률 상담을 위해 사용됩니다.
            </div>
        </form>
    </div>

    <div class="chat-section">
        <div class="messages-container" id="messagesContainer">
            <!-- 초기 메시지 - 일자리 매칭 -->
            <div class="message bot" th:if="${category == 'jobs'}">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
안녕하세요! 노인 일자리 매칭 서비스입니다.

왼쪽에 프로필을 입력하시고, 궁금하신 점을 질문해주세요.

예시:
- "무릎이 안 좋은데 할 수 있는 일자리가 있나요?"
- "주 3일 정도만 일하고 싶어요"
- "사무직 경험이 있는데 관련 일자리 추천해주세요"
                </div>
            </div>

            <!-- 초기 메시지 - 복지 -->
            <div class="message bot" th:if="${category == 'welfare'}">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
안녕하세요! 문화 및 여가 생활 안내 서비스입니다.

왼쪽에 지역과 대상 정보를 입력하시고, 궁금하신 점을 질문해주세요.

예시:
- "노인을 위한 복지 혜택에는 어떤 것이 있나요?"
- "기초연금 신청 방법을 알려주세요"
- "의료비 지원 받을 수 있나요?"
                </div>
            </div>

            <!-- 초기 메시지 - 법률 -->
            <div class="message bot" th:if="${category == 'legal'}">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
안녕하세요! 법률 상담 서비스입니다.

왼쪽에 프로필 정보를 입력하시고, 궁금하신 점을 질문해주세요.

예시:
- "상속 관련 법률 상담이 필요해요"
- "부동산 계약서 확인해야 하는데 어떻게 하나요?"
- "소비자 피해를 입었는데 어떻게 대응해야 하나요?"
                </div>
            </div>

            <!-- 초기 메시지 - 뉴스 -->
            <div class="message bot" th:if="${category == 'news'}">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
안녕하세요! 뉴스 검색 서비스입니다.

왼쪽에서 검색 옵션을 선택하시고, 찾고 싶은 뉴스를 질문해주세요.

예시:
- "최근 복지 정책 뉴스를 알려주세요"
- "건강 관련 최신 소식이 궁금해요"
- "정부 지원금 관련 뉴스를 찾아주세요"
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>

        <div class="input-section">
            <div class="input-container">
                <input type="text"
                       id="messageInput"
                       class="message-input"
                       placeholder="메시지를 입력하세요..."
                       autofocus>
                <button id="sendButton" class="send-button">전송</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const category = /*[[${category}]]*/ 'jobs';
    const messagesContainer = document.getElementById('messagesContainer');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');

    // 메시지 전송 함수
    async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // 카테고리별 requestData 생성
        let requestData = {
            category: category,
            query: message
        };

        // 일자리 매칭
        if (category === 'jobs') {
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            const location = document.getElementById('location').value;

            if (!age || !location) {
                alert('프로필 정보를 모두 입력해주세요.');
                return;
            }

            requestData.age = parseInt(age);
            requestData.gender = gender;
            requestData.location = location;
        }

        // 사용자 메시지 표시
        addMessage(message, 'user');
        messageInput.value = '';
        sendButton.disabled = true;

        // 타이핑 인디케이터 표시
        showTypingIndicator();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });

            const rawText = await response.text();
            console.log('API raw response:', rawText);

            let data;
            try {
                data = JSON.parse(rawText);
            } catch (parseError) {
                console.error('JSON parse error:', parseError);
                console.error('Raw text received:', rawText);
                throw new Error('Invalid JSON response');
            }

            // 타이핑 인디케이터 숨기기
            hideTypingIndicator();

            // 봇 응답 표시
            addMessage(data.answer || '죄송합니다. 응답을 받을 수 없습니다.', 'bot');

        } catch (error) {
            console.error('Error:', error);
            hideTypingIndicator();
            addMessage('죄송합니다. 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.', 'bot');
        } finally {
            sendButton.disabled = false;
            messageInput.focus();
        }
    }

    // 메시지 추가 함수
    function addMessage(content, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = sender === 'user' ? '👤' : '🤖';

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.textContent = content;

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // 타이핑 인디케이터 표시/숨기기
    function showTypingIndicator() {
        typingIndicator.classList.add('active');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideTypingIndicator() {
        typingIndicator.classList.remove('active');
    }

    // 이벤트 리스너
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // 페이지 로드 시 입력창에 포커스
    window.addEventListener('load', () => {
        messageInput.focus();
    });
</script>
</body>
</html>

